{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/wpzona.css' %}">
{% endblock %}


{% block content %}
<div class="wpzona-container">
    {% if not region %}
    <div class="alert alert-danger">
        Регион не выбран. <a href="{% url 'wpzona:select_region' %}">Выберите регион</a>.
    </div>
    {% else %}
    <h1>WPzona - {{ region.name }}</h1>
    <p class="text-center mb-4">Pet-friendly места в выбранном регионе</p>

    <!-- Блок погоды -->
    <div class="weather-card">
        <h2><i class="bi bi-cloud-sun"></i> Погода в {{ region.name }}</h2>
        {% if weather %}
        <div class="weather-details">
            <img src="http://openweathermap.org/img/wn/{{ weather.weather.0.icon }}@2x.png" alt="Weather icon"
                 class="weather-icon">
            <div>
                <div class="weather-temp">{{ weather.main.temp|floatformat:0 }}°C</div>
                <div class="weather-desc">{{ weather.weather.0.description|capfirst }}</div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-4">
                <p><i class="bi bi-droplet"></i> Влажность: {{ weather.main.humidity }}%</p>
            </div>
            <div class="col-md-4">
                <p><i class="bi bi-wind"></i> Ветер: {{ weather.wind.speed }} м/с</p>
            </div>
            <div class="col-md-4">
                <p><i class="bi bi-thermometer"></i> Ощущается как: {{ weather.main.feels_like|floatformat:0 }}°C
                </p>
            </div>
        </div>
        {% else %}
        <div class="alert alert-warning">
            Не удалось загрузить данные о погоде.
        </div>
        {% endif %}
    </div>

    <!-- Блок карты -->
    <div class="map-container">
        <h2><i class="bi bi-map"></i> Карта pet-friendly мест</h2>
        <div id="petMap"></div>
    </div>

    <!-- Форма для добавления мест -->
    {% if user.is_authenticated %}
    <div class="place-form">
        <h3><i class="bi bi-plus-circle"></i> Предложить новое место</h3>
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            {{ form.as_p }}
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-send"></i> Отправить на модерацию
            </button>
        </form>
    </div>
    {% else %}
    <div class="alert alert-info">
        <a href="{% url 'login' %}?next={{ request.path }}">Войдите</a>, чтобы предложить новое место.
    </div>
    {% endif %}

    <!-- Список мест -->
    <div class="place-list">
        <h3><i class="bi bi-geo-alt"></i> Pet-friendly места в {{ region.name }}</h3>
        {% if places %}
        <div class="row">
            {% for place in places %}
            <div class="col-md-6">
                <div class="place-item">
                    <h5>{{ place.submission.name }}</h5>
                    <p>{{ place.submission.description }}</p>
                    <p class="text-muted"><small>{{ place.submission.address }}</small></p>
                    <button class="btn btn-sm btn-outline-secondary view-on-map"
                            data-lat="{{ place.latitude }}"
                            data-lng="{{ place.longitude }}">
                        Показать на карте
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="alert alert-info">
            В этом регионе пока нет добавленных мест.
        </div>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const map = L.map('petMap').setView([{{ region.latitude }}, {{ region.longitude }}], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        // Добавление маркеров
        {% for place in places %}
        L.marker([{{ place.latitude }}, {{ place.longitude }}]).addTo(map)
            .bindPopup(`
                <h5>{{ place.submission.name|escapejs }}</h5>
                <p>{{ place.submission.description|escapejs }}</p>
                <small>{{ place.submission.address|escapejs }}</small>
                {% if place.submission.photo %}
                <img src="{{ place.submission.photo.url }}" style="max-width: 100%; margin-top: 10px;">
                {% endif %}
            `);
        {% endfor %}

        // Обработка кнопок "Показать на карте"
        document.querySelectorAll('.view-on-map').forEach(btn => {
            btn.addEventListener('click', function() {
                const lat = parseFloat(this.dataset.lat);
                const lng = parseFloat(this.dataset.lng);
                map.flyTo([lat, lng], 15);
            });
        });
    });
</script>
{% endblock %}